{% extends "base.html" %}

{% block title %}Branch Graph for Game #{{ game_id }} - AI GM Web UI{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
{% endblock %}

{% block content %}
    <div class="nav">
        <a href="/game/{{ game_id }}">&larr; Back to Game Details</a>
    </div>

    <h2>Branch Graph for Game #{{ game_id }}</h2>

    <div id="graph-container" style="text-align: center;">
        <div class="mermaid">
            graph TD;
                A[Loading graph...];
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });

        async function fetchAndRenderGraph() {
            try {
                const response = await fetch('/game/{{ game_id }}/graph-data');
                if (!response.ok) {
                    throw new Error('Failed to fetch graph data');
                }
                const data = await response.json();
                
                // 使用 flowchart 代替 graph，对特殊字符支持更好
                let mermaidDefinition = 'flowchart TD;\n';

                data.nodes.forEach(node => {
                    // 正确清理和转义标签文本
                    // 1. 将换行符转换为 HTML <br/>
                    // 2. 转义双引号为 &quot;
                    // 3. 转义其他 HTML 特殊字符
                    let sanitizedLabel = node.label
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/\n/g, '<br/>');
                    
                    // 使用方括号节点以支持多行文本
                    mermaidDefinition += `    ${node.id}["${sanitizedLabel}"];\n`;
                });

                data.edges.forEach(edge => {
                    mermaidDefinition += `    ${edge.from} --> ${edge.to};\n`;
                });

                // 调试：输出生成的 Mermaid 定义
                console.log('Generated Mermaid definition:', mermaidDefinition);

                const container = document.querySelector('.mermaid');
                container.textContent = mermaidDefinition;
                
                // 渲染新内容
                await mermaid.run({
                    nodes: [container]
                });

            } catch (error) {
                console.error('Error rendering graph:', error);
                const container = document.querySelector('.mermaid');
                container.textContent = 'flowchart TD; A[Error loading graph];';
                await mermaid.run({
                    nodes: [container]
                });
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAndRenderGraph);
    </script>
{% endblock %}
