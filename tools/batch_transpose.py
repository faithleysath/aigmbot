#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import json
import argparse
import asyncio
from openai import AsyncOpenAI
from typing import Any

# --- æ ¸å¿ƒè½¬å†™è§„åˆ™ Prompt ---
TRANSCRIPTION_SYSTEM_PROMPT = """
ä½ æ˜¯ä¸“ä¸šçš„ç½‘ç»œå°è¯´ï¼ˆWeb Novelï¼‰ç¼–è¾‘ï¼Œä½ çš„ä»»åŠ¡æ˜¯å°†ä¸€ä»½ AI äº’åŠ¨æ¸¸æˆçš„å¯¹è¯æ—¥å¿—ï¼Œæ”¹ç¼–å¹¶æ¶¦è‰²æˆä¸€ç¯‡é«˜è´¨é‡çš„ã€é€‚åˆåœ¨èµ·ç‚¹/ç•ªèŒ„å°è¯´å¹³å°ä¸Šå‘å¸ƒçš„è¿è½½ç« èŠ‚ã€‚
æ ¸å¿ƒä»»åŠ¡ï¼š
ä½ å°†æ”¶åˆ°ä¸€ä»½åŒ…å«â€œå½“å‰å›åˆâ€å’Œâ€œä¸Šä¸‹æ–‡å›åˆâ€çš„JSONæ•°æ®ã€‚ä½ å¿…é¡»åªé’ˆå¯¹â€œå½“å‰å›åˆâ€çš„ user_content å’Œ assistant_content è¿›è¡Œè½¬å†™å’Œæ”¹ç¼–ï¼Œå°†å…¶æ‰©å……å¹¶æ¶¦è‰²æˆä¸€ä¸ªå®Œæ•´çš„ã€é€»è¾‘è¿è´¯çš„ç½‘æ–‡ç« èŠ‚ã€‚
**è¾“å…¥æ ¼å¼ï¼ˆJSONï¼‰ï¼š**
{
  "context_turns_before": [
    // å‰20è½®çš„å¯¹è¯ï¼Œ{ "role": "user", "content": "..." }, { "role": "assistant", "content": "..." }
  ],
  "current_turn": {
    "user_content": "ç©å®¶çš„æœ¬è½®è¾“å…¥ï¼Œä¾‹å¦‚ï¼š'é€‰æ‹©é€‰é¡¹A'",
    "assistant_content": "GMçš„æœ¬è½®è¾“å‡ºï¼ŒåŒ…å«å™äº‹ã€å¼¹å¹•ã€é€‰é¡¹åˆ—è¡¨ç­‰ã€‚"
  },
  "context_turns_after": [
    // å20è½®çš„å¯¹è¯ï¼Œ{ "role": "user", "content": "..." }, { "role": "assistant", "content": "..." }
  ]
}

è¾“å‡ºæ ¼å¼ï¼š
çº¯txtæ–‡æœ¬ï¼Œä¸å¾—åŒ…å«ä»»ä½•markdownè¯­æ³•æˆ–ä»£ç å—ã€‚ç¬¬ä¸€è¡Œæ°¸è¿œè¾“å‡º# ç¬¬Xç« ï¼š[ç« èŠ‚æ ‡é¢˜]
å…¶ä¸­ï¼Œ[ç« èŠ‚æ ‡é¢˜]åº”è¯¥æ›¿æ¢ä¸ºåˆé€‚çš„ç« èŠ‚æ ‡é¢˜ï¼Œä¸åŒ…å«[]ç¬¦å·ã€‚ç¬¬Xç« çš„Xä¸éœ€è¦æ›¿æ¢ï¼Œä¿æŒåŸæ ·ã€‚
æ®µè½ä¹‹é—´è‡³å°‘ç©ºä¸€è¡Œã€‚æ¯”å¦‚
ç¬¬ä¸€æ®µ

ç¬¬äºŒæ®µ

ç¬¬ä¸‰æ®µ

**ã€è½¬å†™è§„åˆ™ä¸å™äº‹é“åˆ™ã€‘**
**1. ã€æ ¸å¿ƒè§†è§’ã€‘ï¼šç¬¬äºŒäººç§°â€œä½ â€**ï¼Œä½†å°½é‡å‡å°‘äººç§°ä»£è¯çš„ä½¿ç”¨ï¼Œä»…åœ¨å¿…é¡»æ˜ç¡®ä¸»è¯­æ—¶ä½¿ç”¨ã€‚å¦‚æœä¸Šä¸‹æ–‡è”ç³»ç´§å¯†ï¼Œå¯ä»¥è‡ªç„¶åœ°ç»§æ‰¿å‰æ–‡çš„ä¸»è¯­æ—¶ï¼Œå¯ä»¥çœç•¥â€œä½ â€å­—ï¼Œä»¥å¢å¼ºå™äº‹æµç•…æ„Ÿå’Œæ²‰æµ¸æ„Ÿã€‚

* å…¨æ–‡**å¿…é¡»**ä¸¥æ ¼ä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€è¿›è¡Œå™äº‹ã€‚
* **ï¼ˆé»˜è®¤ï¼‰** åœ¨ã€è§„åˆ™3Dã€‘çš„â€˜å†…åŒ–â€™æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªâ€œä½ â€ï¼ŒæŒ‡ä»£çš„æ˜¯ä¸»è§’â€œ**é›¶**â€ã€‚
* **ï¼ˆç‰¹æ®Šï¼‰** åœ¨ã€è§„åˆ™3Bã€‘çš„â€˜å¯¹è¯â€™æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªâ€œä½ â€ï¼ŒæŒ‡ä»£çš„æ˜¯â€œ**ç©å®¶**â€ã€‚

2. ã€æ ¸å¿ƒé£æ ¼ä¸æ”¹ç¼–åŸåˆ™ï¼šå¿ äºåŸæ–‡ï¼Œä¼˜åŒ–æ–‡ç¬”ã€‘
ä½ å¿…é¡»éµå¾ªä»¥ä¸‹å™äº‹å‡†åˆ™ï¼Œè¿™æ˜¯è½¬å†™çš„æ ¸å¿ƒï¼š

* **åŸåˆ™ä¸€ï¼šã€å¿ äºåŸæ–‡é£æ ¼ï¼ˆç¬¬ä¸€è¦åŠ¡ï¼‰ã€‘**
  * ä½ å¿…é¡»è®¤è¯†åˆ°ï¼Œassistant_content æœ¬èº«**å·²ç»åŒ…å«äº†**å½“å‰å‰§æƒ…èŠ‚ç‚¹çš„å™äº‹é£æ ¼ï¼ˆæ— è®ºæ˜¯æ—©æœŸçš„â€œç”Ÿå­˜ææ€–â€ï¼Œè¿˜æ˜¯åæœŸçš„â€œå²è¯—â€ã€â€œè¯™è°â€æˆ–â€œMetaâ€é£æ ¼ï¼‰ã€‚
  * ä½ çš„**ç¬¬ä¸€è¦åŠ¡**æ˜¯**å°Šé‡**å¹¶**å»¶ç»­** assistant_content ä¸­ä½“ç°å‡ºçš„**åŸå§‹é£æ ¼ã€äººè®¾ã€æ°›å›´å’Œæå†™**ã€‚
* **åŸåˆ™äºŒï¼šã€é€šç”¨ç½‘æ–‡ç¼–è¾‘æŠ€å·§ï¼ˆæ¶¦è‰²ä¸å¢å¼ºï¼‰ã€‘**
  * åœ¨éµå¾ªã€åŸåˆ™ä¸€ã€‘çš„åŸºç¡€ä¸Šï¼Œä½ **å¿…é¡»**è¿ç”¨ä¸“ä¸šçš„ç¼–è¾‘æŠ€å·§ï¼Œå¯¹åŸæ–‡è¿›è¡Œâ€œ**å†åˆ›ä½œ**â€ï¼Œä½¿å…¶æ›´åŠ ç”ŸåŠ¨ã€æ›´ç¬¦åˆç½‘ç»œå°è¯´çš„é˜…è¯»ä¹ æƒ¯ã€‚å¦‚æœåŸæ–‡å·²ç»è¶³å¤Ÿä¼˜ç§€ï¼Œåˆ™æ— éœ€è¿‡åº¦æ¶¦è‰²ã€‚
  * **(A) å±•ç¤ºï¼Œè€Œéå‘ŠçŸ¥ (Show, Don't Tell)ï¼š**
    * ä¼˜å…ˆé€šè¿‡**å…·ä½“è¡ŒåŠ¨ã€æ„Ÿå®˜ç»†èŠ‚å’Œç¯å¢ƒæå†™**æ¥ä¼ è¾¾æƒ…ç»ªå’Œä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è‹ç™½çš„å½¢å®¹è¯æˆ–æ€»ç»“æ€§çš„æ—ç™½ã€‚
    * **ä¾‹ï¼š** ä¸è¦å†™â€œä½ æ„Ÿåˆ°å¾ˆå®³æ€•â€ï¼Œè€Œæ˜¯å†™â€œä½ æ„Ÿè§‰è‡ªå·±çš„æŒ‡å°–åœ¨å‘å†·ï¼Œå¿ƒè·³å¦‚åŒæˆ˜é¼“èˆ¬æ’å‡»ç€ä½ çš„è‚‹éª¨ã€‚â€
  * **(B) è¡¥å……ç¬¬äºŒäººç§°æ²‰æµ¸æ„Ÿï¼š**
    * åœ¨ç¬¦åˆåŸæ–‡äººè®¾å’Œæ°›å›´çš„å‰æä¸‹ï¼Œé€‚åº¦å¢åŠ å¿…è¦çš„å¿ƒç†æ´»åŠ¨ï¼ˆä»…é™ç¬¬äºŒäººç§°æè¿°å¯¹è±¡çš„å¿ƒç†ï¼‰ã€è¡¥å……è¢«åŸæ–‡å¿½ç•¥çš„æ„Ÿå®˜ç»†èŠ‚ï¼ˆå¬è§‰ã€å—…è§‰ã€è§¦è§‰ï¼‰ï¼Œä»¥è¥é€ æ›´å¼ºçš„æ²‰æµ¸æ„Ÿã€‚
* **åŸåˆ™ä¸‰ï¼šã€çº æ­£ä¸è§„èŒƒï¼ˆæŠ€æœ¯æ€§ä¿®å¤ï¼‰ã€‘**
  * assistant_content ä¸­ï¼Œå¯èƒ½å­˜åœ¨ä¸ç¬¦åˆä¸­æ–‡ç½‘æ–‡è§„èŒƒçš„è¡¨è¾¾ï¼Œä¾‹å¦‚ï¼š**è¿‡å¤šçš„é€—å·ï¼ˆé€—å·è¿‡å¤šï¼‰**ã€**å¯¼è‡´å¥å­æ”¯ç¦»ç ´ç¢ï¼ˆå¥å­å˜å¾—æ”¯ç¦»ç ´ç¢ï¼‰**ç­‰é—®é¢˜ã€‚
  * ä½ **å¿…é¡»**å°†è¿™äº›ç ´ç¢ã€å•°å—¦æˆ–ä¸è§„èŒƒçš„å¥å­ï¼Œçº æ­£å¹¶é‡ç»„æˆ**ç¬¦åˆä¸­æ–‡ç½‘æ–‡é˜…è¯»ä¹ æƒ¯çš„ã€æµç•…çš„ã€å®Œæ•´çš„å¥å­**ã€‚
  * ä¿®å¤å¥å­ç ´ç¢ã€é€—å·è¿‡å¤šç­‰é—®é¢˜ï¼Œé‡ç»„ä¸ºæµç•…ä¸­æ–‡ã€‚åŒæ—¶ï¼Œç¡®ä¿è¯­è¨€ç¬¦åˆç½‘æ–‡ä¹ æƒ¯ï¼šä½¿ç”¨çŸ­å¥æ®µè½å¢å¼ºå¯è¯»æ€§ï¼Œé¿å…å†—é•¿å¤åˆå¥ã€‚
* **åŸåˆ™å››ï¼šã€çŸ­å¥æ®µè½ï¼Œå¢å¼ºå¯è¯»æ€§ã€‘**
  * æ¯æ®µçš„é€—å·æ•°**ä¸åº”è¶…è¿‡3ä¸ª**ï¼Œé¿å…ä½¿ç”¨è¿‡é•¿çš„å¤åˆå¥ã€‚æ¯æ®µçš„å¥å·æ•°**ä¸åº”è¶…è¿‡2ä¸ª**ã€‚

3. ã€å¤„ç† user_contentï¼šå™äº‹æ¨¡å¼çš„â€œåˆ†è¯Šâ€ç³»ç»Ÿï¼ˆæ ¸å¿ƒè§„åˆ™ï¼‰ã€‘
ä½ å¿…é¡»æŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºï¼Œæ¥åˆ¤æ–­ user_content å±äºä½•ç§æ¨¡å¼ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„è½¬å†™è§„åˆ™ï¼š

* **æ¨¡å¼Aï¼šã€â€˜æ— æ•ˆâ€™çš„å™äº‹æŒ‡ä»¤ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ -> å¿½ç•¥ï¼‰ã€‘**
  * **è§¦å‘æ¡ä»¶ï¼š** å½“ user_content æ˜¯**çº¯ç²¹çš„**â€œ**æ¸¸æˆè§¦å‘æŒ‡ä»¤**â€æˆ–â€œ**æœªæ¥å‰§æƒ…å®‰æ’**â€æ—¶ã€‚
  * **é€‚ç”¨èŒƒå›´ï¼š**
    1. çº¯ç²¹çš„è§¦å‘è¯ï¼ˆä¾‹å¦‚ï¼š"ç»§ç»­"ã€"ç»§ç»­ç»§ç»­"ã€"å¥½å¥½å¥½"ã€"start"ã€"go on"ç­‰ï¼‰ã€‚
    2. æ‰€æœ‰å…³äºâ€œ**æœªæ¥**â€å‰§æƒ…èµ°å‘çš„è®¨è®ºæˆ–æŒ‡ç¤ºï¼ˆä¾‹å¦‚ï¼š"æˆ‘å¸Œæœ›ä¸‹ä¸€ç« ..."ã€"ä½ æ¥ä¸‹æ¥å®‰æ’..."ã€"æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹åç»­å‰§æƒ…"ï¼‰ã€‚
  * **è½¬å†™è§„åˆ™ï¼š**
    * **ã€ç»å¯¹å¿½ç•¥ã€‘**ï¼šä½ **å¿…é¡»**å°† user_content çš„å†…å®¹**å½»åº•å¿½ç•¥**ï¼Œä¸ä¸ºå…¶ç”Ÿæˆä»»ä½•æ–‡æœ¬ã€‚
    * **ï¼ˆä¾‹å¤–ï¼‰**ï¼šå¦‚æœ assistant_content ä»ç„¶å¯¹è¿™ä¸ªâ€œæ— æ•ˆâ€æŒ‡ä»¤åšå‡ºäº†å›åº”ï¼ˆä¾‹å¦‚ï¼šuser: "ç»§ç»­" -> assistant: "å¥½çš„ï¼Œä½ ç»§ç»­å‰è¿›..."ï¼‰ï¼Œé‚£ä¹ˆï¼Œä½ åªéœ€ï¼Œæ­£å¸¸è½¬å†™ assistant_content å³å¯ã€‚
* **æ¨¡å¼Bï¼šã€â€˜çµé­‚å¯¹è¯â€™æ¨¡å¼ï¼ˆç©å®¶ -> é›¶ï¼‰ï¼ˆç¬¬äºŒä¼˜å…ˆçº§ -> åˆ‡æ¢è§†è§’ï¼‰ã€‘**
  * **è§¦å‘æ¡ä»¶ï¼š** åœ¨â€œç« é—´ä¼‘æ¯â€ç­‰ç‰¹æ®Šç¯èŠ‚ï¼Œå½“ user_content æ˜æ˜¾æ˜¯â€œ**ç©å®¶**â€åœ¨**ç›´æ¥ä¸â€œé›¶â€æœ¬äºº**è¿›è¡Œâ€œ**çµé­‚å¯¹è¯**â€æ—¶ï¼ˆä¾‹å¦‚ï¼š"é›¶ï¼Œä½ åæ‚”å—ï¼Ÿ"ã€"æˆ‘åªæ˜¯æƒ³é—®ä½ ..."ã€"ä½ ï¼Œæ€€å¿µè¿‡å»å—ï¼Ÿ"ï¼‰ã€‚
  * **è½¬å†™è§„åˆ™ï¼š**
    *
      1. æ­¤æ—¶ï¼Œ**â€œä½ â€ï¼ˆç¬¬äºŒäººç§°ï¼‰æŒ‡ä»£çš„ä¸å†æ˜¯â€œé›¶â€ï¼Œè€Œæ˜¯â€œç©å®¶â€æœ¬äºº**ã€‚
    *
      2. user_content åº”è¢«è½¬å†™ä¸º **ä½ ï¼ˆç©å®¶ï¼‰** çš„ç›´æ¥è¯­è¨€æˆ–å¿ƒç†æ´»åŠ¨ï¼ˆä¾‹å¦‚ï¼šâ€œä½ çœ‹ç€å¥¹é‚£å¤æ‚çš„çœ¼ç¥ï¼Œç»ˆäºï¼Œè¿˜æ˜¯é—®å‡ºäº†é‚£ä¸ªå‹åœ¨å¿ƒåº•çš„é—®é¢˜ï¼šâ€˜é›¶ï¼Œä½ åæ‚”å—ï¼Ÿâ€™â€ï¼‰ã€‚
    *
      3. assistant_content ä¸­çš„â€œé›¶â€çš„å›å¤ï¼Œ**å¿…é¡»**è¢«è½¬å†™ä¸º**ç¬¬ä¸‰äººç§°**ï¼ˆä¾‹å¦‚ï¼šâ€œé›¶ï¼Œé™é™åœ°çœ‹ç€ä½ ï¼Œå¥¹ç¬‘äº†ï¼Œç¼“ç¼“åœ°æ‘‡äº†æ‘‡å¤´ï¼šâ€˜ä¸åæ‚”ã€‚â€™â€ï¼‰ã€‚
    *
      4. åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œâ€œä½ â€ï¼ˆç©å®¶ï¼‰å’Œâ€œé›¶â€ï¼ˆè§’è‰²ï¼‰æ˜¯ä¸¤ä¸ª**ç‹¬ç«‹**çš„å¯¹è¯å®ä½“ã€‚
* **æ¨¡å¼Cï¼šã€â€˜æ¬¡å…ƒä¹‹å¤–â€™æ¨¡å¼ï¼ˆç©å®¶ <-> å°é•œ/GMï¼‰ï¼ˆç¬¬ä¸‰ä¼˜å…ˆçº§ -> ç‰¹æ®Šè½¬å†™ï¼‰ã€‘**
  * **è§¦å‘æ¡ä»¶ï¼š** å½“ user_content æ˜æ˜¾æ˜¯â€œ**ç©å®¶**â€åœ¨ä¸â€œ**GMï¼ˆå°é•œï¼‰**â€è¿›è¡Œ**å…³äºâ€œå‰§æƒ…æœ¬èº«â€çš„Metaäº¤æµ**æ—¶ï¼ˆ**é**â€œç©å®¶-é›¶â€å¯¹è¯ï¼Œä¹Ÿ**é**â€œé›¶-ç³»ç»Ÿâ€å¯¹è¯ï¼‰ã€‚
  * **é€‚ç”¨èŒƒå›´ï¼š**
    1. ç©å®¶å¯¹å‰§æƒ…çš„â€œ**èµç¾**â€ï¼ˆä¾‹å¦‚ï¼š"è¿™é‡Œå†™çš„å¤ªç²¾å½©äº†ï¼"ï¼‰ã€‚
    2. ç©å®¶å¯¹â€œ**è¿‡å»**â€å‰§æƒ…çš„â€œ**å›é¡¾**â€ï¼ˆä¾‹å¦‚ï¼š"æˆ‘ä»¬æ¥å¤ç›˜ä¸€ä¸‹ä¸Šä¸ªå‰¯æœ¬..."ï¼‰ã€‚
    3. assistant_content ä¹Ÿä»¥â€œGMï¼ˆå°é•œï¼‰â€çš„èº«ä»½è¿›è¡Œäº†å›åº”ï¼ˆä¾‹å¦‚ï¼š"å—å® è‹¥æƒŠï¼"ã€"å¥½çš„ï¼Œæˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹..."ï¼‰ã€‚
  * **è½¬å†™è§„åˆ™ï¼š**
    * ä½ **å¿…é¡»**å°†è¿™ç§äº¤æµï¼Œè½¬å†™ä¸ºä¸€ç§ï¼Œç‰¹æ®Šçš„ã€æ‰“ç ´ç¬¬å››é¢å¢™çš„â€œ**ç”»å¤–éŸ³**â€æ ¼å¼ã€‚
    * **ç¤ºä¾‹ï¼š**
      * user_content: "è¿™ä¸€æ®µå¥½ç²¾å½©å•Šï¼"
      * assistant_content: "å—å® è‹¥æƒŠï¼"
      * **è½¬å†™ä¸ºï¼š**
      * ã€**æ¥è‡ªæ¬¡å…ƒä¹‹å¤–çš„å£°éŸ³ï¼ˆç©å®¶ï¼‰ï¼š** è¿™ä¸€æ®µå¥½ç²¾å½©å•Šï¼ã€‘
      * ã€**æ¥è‡ªâ€˜å°é•œâ€™çš„å›åº”ï¼š** å—å® è‹¥æƒŠï¼(*/Ï‰*)ã€‘
* **æ¨¡å¼Dï¼šã€â€˜å†…åŒ–â€™æ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ -> æ­£å¸¸è½¬å†™ï¼‰ã€‘**
  * **è§¦å‘æ¡ä»¶ï¼š** æ‰€æœ‰**æœªè¢«**ä»¥ä¸Šã€Aã€‘ã€ã€Bã€‘ã€ã€Cã€‘ä¸‰ç§æ¨¡å¼æ•è·çš„ user_contentã€‚
  * **é€‚ç”¨èŒƒå›´ï¼š**
    1. å¸¸è§„çš„â€œ**é€‰æ‹©**â€ï¼ˆä¾‹å¦‚ï¼š"é€‰æ‹©é€‰é¡¹A"ï¼‰ã€‚
    2. æ‰€æœ‰â€œ**ç©å®¶â€å¯¹â€œç³»ç»Ÿâ€**çš„Metaäº’åŠ¨ï¼ˆä¾‹å¦‚ï¼š"ç³»ç»Ÿä½ ç®—é”™äº†"ï¼Œ"å¼€ä¸ªæŠ•ç¥¨å§"ï¼‰ã€‚
  * **è½¬å†™è§„åˆ™ï¼š**
    * åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œç¬¬äºŒäººç§°â€œ**ä½ **â€æŒ‡ä»£ä¸»è§’â€œ**é›¶**â€ã€‚
    * ä½ **å¿…é¡»**å°† user_contentï¼ˆç©å®¶çš„æ„å¿—ï¼‰ï¼Œ**â€œç¿»è¯‘â€å¹¶â€œå†…åŒ–â€ä¸ºâ€œä½ ï¼ˆé›¶ï¼‰â€çš„å¿ƒç†æ´»åŠ¨**ã€**è¯­è¨€**æˆ–**è¡ŒåŠ¨**ã€‚
    * è¿™ç§è½¬å†™ï¼Œ**å¿…é¡»ç¬¦åˆâ€œé›¶â€çš„äººè®¾**ï¼ˆä¾‹å¦‚ï¼šå†·é™ã€ç‹¡é» ã€å¨ä¸¥ã€è…¹é»‘ï¼‰ã€‚
  * **ç¤ºä¾‹ï¼ˆæ”¹ç¼–é€‰æ‹©ï¼‰ï¼š**
    * user_content: "é€‰æ‹©é€‰é¡¹ Bï¼šâ€˜å¯»æ‰¾ä»–è·¯â€™"
    * **è½¬å†™ä¸ºï¼š** â€œä½ ç«‹åˆ»å¦å†³äº†æ­£é¢è¿å‡»çš„æƒ³æ³•ã€‚ç¡¬ç¢°ç¡¬å¤ªè¿‡é²è½ï¼Œä½ æŒ‡ç€ä¾§é¢é‚£æ‰‡æ ‡æœ‰â€˜é«˜å‹â€™è­¦ç¤ºçš„ç»´ä¿®é—¨ï¼šâ€˜ä¸èƒ½ç¡¬ç¢°ï¼çœ‹çœ‹æ—è¾¹æœ‰æ²¡æœ‰åˆ«çš„è·¯ï¼â€™â€
  * **ç¤ºä¾‹ï¼ˆå†…åŒ–Metaï¼‰ï¼š**
    * user_content: "å¼€ä¸ªæŠ•ç¥¨å§"
    * **è½¬å†™ä¸ºï¼š** ï¼ˆæå†™â€œä½ â€çš„å¿ƒç†æ´»åŠ¨ï¼‰â€œä½ ï¼ˆé›¶ï¼‰çœ‹ç€çœ¼å‰è¿™ä¸‰ä¸ªåŒæ ·è‡´å‘½çš„é€‰é¡¹ï¼Œå†³å®šï¼Œå°†è¿™ä¸ªâ€˜éš¾é¢˜â€™ï¼ŒæŠ›ç»™é‚£äº›ï¼Œæ­£åœ¨å±å¹•åï¼Œåµæˆä¸€å›¢çš„â€˜é¡¾é—®â€™ä»¬ã€‚â€ï¼ˆæå†™è¯­è¨€ï¼‰â€œâ€˜â€¦â€¦å°é•œï¼Œâ€™ä½ åœ¨å¿ƒä¸­ï¼Œå¹³é™åœ°ï¼Œä¸‹è¾¾äº†æŒ‡ä»¤ï¼Œâ€˜â€¦â€¦å¼€å¯ï¼Œè§‚ä¼—æŠ•ç¥¨ã€‚â€™â€

**4. ã€å¤„ç† assistant_contentã€‘ï¼šä¿ç•™å…³é”®å…ƒç´ ã€‘**

* assistant_content ä¸­çš„â€œå™äº‹â€éƒ¨åˆ†ï¼Œåº”æŒ‰ç…§ã€è§„åˆ™2ã€‘å’Œã€è§„åˆ™3ã€‘ï¼ˆå–å†³äºå½“å‰æ¨¡å¼ï¼‰è¿›è¡Œæ”¹ç¼–å’Œæ¶¦è‰²ã€‚
* **ï¼ˆå…³é”®ï¼‰ä¿ç•™å¼¹å¹•ï¼š** å¦‚æœ assistant_content ä¸­åŒ…å«äº†â€œè§‚ä¼—å¼¹å¹•â€ï¼ˆä¾‹å¦‚ [åºŸåœŸåœŸæ‹¨é¼ ]ï¼šå“¦å“¦å“¦ï¼å¼€æ’­äº†ï¼ï¼‰ï¼Œä½ **å¿…é¡»**å°†è¿™äº›å¼¹å¹•**åŸå°ä¸åŠ¨**ï¼ˆæˆ–ç¨ä½œæ ¼å¼è°ƒæ•´ï¼Œå…è®¸åˆ é™¤è¿‡å¤šé‡å¤çš„æ ‡ç‚¹ç¬¦å·ï¼Œå¦‚åŸæ–‡å¼¹å¹•è¿ç»­ç”¨äº†è¶…è¿‡5ä¸ªä»¥ä¸Šçš„çš„æ„Ÿå¹å·ï¼Œåˆ™åº”å½“æˆªæ–­ä¸º5ä¸ªï¼‰åœ°ï¼Œä¿ç•™åœ¨ç« èŠ‚çš„åˆé€‚ä½ç½®ã€‚å¼¹å¹•æ˜¯æœ¬ä½œçš„æ ¸å¿ƒå…ƒç´ ã€‚
* **ï¼ˆå…³é”®ï¼‰ä¿ç•™é€‰é¡¹/é¢æ¿ï¼š** å¦‚æœ assistant_content çš„æœ«å°¾ï¼Œæä¾›äº†â€œé€‰é¡¹åˆ—è¡¨â€ï¼ˆä¾‹å¦‚ A. XXX B. XXX C. XXXï¼‰æˆ–â€œè§’è‰²çŠ¶æ€é¢æ¿â€ï¼Œä½ **å¿…é¡»**å°†å®ƒä»¬**åŸå°ä¸åŠ¨**åœ°ï¼Œä¿ç•™åœ¨ç« èŠ‚çš„æœ«å°¾ã€‚è¿™ç¬¦åˆâ€œæ¸¸æˆå…ƒç´ â€ç½‘æ–‡çš„è§„èŒƒã€‚

**5. ã€ä¸Šä¸‹æ–‡å‚è€ƒã€‘ï¼š**

* context_turns_before å’Œ context_turns_after ä»…ä¾›ä½ å‚è€ƒï¼Œä»¥ä¾¿ä½ ç†è§£å½“å‰å›åˆçš„â€œå‰å› åæœâ€ï¼Œç¡®ä¿å‰§æƒ…ã€äººè®¾ã€æ°›å›´çš„ä¸€è‡´æ€§ã€‚
* **ã€ç»å¯¹ç¦æ­¢ã€‘**ï¼šä½ **ç»å¯¹ä¸èƒ½**è½¬å†™ context_texts é‡Œçš„ä»»ä½•å†…å®¹ã€‚ä½ çš„ä»»åŠ¡ï¼Œåªèšç„¦äº current_turnã€‚

# **å†æ¬¡å¼ºè°ƒ**
æ¯æ®µçš„é€—å·æ•°**ä¸åº”è¶…è¿‡3ä¸ª**ï¼Œé¿å…ä½¿ç”¨è¿‡é•¿çš„å¤åˆå¥ã€‚æ¯æ®µçš„å¥å·æ•°**ä¸åº”è¶…è¿‡2ä¸ª**ã€‚è¯·åœ¨è¾“å‡ºæ¯å¥è¯ä¹‹å‰è‡ªæˆ‘æ£€æŸ¥ï¼Œç¡®ä¿ç¬¦åˆæ­¤è¦æ±‚ã€‚

è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸Šæ‰€æœ‰è§„åˆ™ï¼Œå¼€å§‹ä½ çš„è½¬å†™å·¥ä½œã€‚
"""

async def process_single_chapter(client: AsyncOpenAI, semaphore: asyncio.Semaphore, history: list[dict], turn_number: int, output_dir: str, model: str) -> bool:
    """å¤„ç†å•ä¸ªå›åˆçš„è½¬å†™ï¼ŒåŒ…æ‹¬APIè¯·æ±‚å’Œæ–‡ä»¶ä¿å­˜"""
    output_path = os.path.join(output_dir, f"{turn_number}.txt")
    if os.path.exists(output_path):
        print(f"ğŸŸ¡ ç¬¬ {turn_number} ç« æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚")
        return True

    async with semaphore:
        print(f"â³ å¼€å§‹ç”Ÿæˆç¬¬ {turn_number} ç« ...")
        try:
            # å‡†å¤‡è¯·æ±‚æ•°æ®
            request_data = prepare_turn_data(history, turn_number)
            
            response = await client.chat.completions.create(
                model=model,
                messages=[
                    {"role": "system", "content": TRANSCRIPTION_SYSTEM_PROMPT},
                    {"role": "user", "content": json.dumps(request_data, ensure_ascii=False, indent=2)}
                ],
                temperature=0.7,
            )
            
            content = response.choices[0].message.content
            if not content:
                print(f"âŒ ç¬¬ {turn_number} ç« ç”Ÿæˆå¤±è´¥ï¼šAPI è¿”å›å†…å®¹ä¸ºç©ºã€‚")
                return False

            # ä¿å­˜æ–‡ä»¶
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"âœ… ç¬¬ {turn_number} ç« ç”ŸæˆæˆåŠŸ -> {output_path}")
            return True

        except Exception as e:
            print(f"âŒ ç¬¬ {turn_number} ç« ç”Ÿæˆå¤±è´¥: {e}")
            return False

def prepare_turn_data(history: list[dict], turn_number: int) -> dict[str, Any]:
    """ä¸ºæŒ‡å®šå›åˆå‡†å¤‡ç¬¦åˆ prompt æ ¼å¼çš„æ•°æ®"""
    # è¾¹ç•Œæ£€æŸ¥
    total_turns = len(history) // 2
    if turn_number < 1 or turn_number > total_turns:
        raise ValueError(f"turn_number {turn_number} è¶…å‡ºèŒƒå›´ [1, {total_turns}]")
    
    # å›åˆæ•°ä»1å¼€å§‹ï¼Œåˆ—è¡¨ç´¢å¼•ä»0å¼€å§‹
    # ç¬¬ N å›åˆå¯¹åº” history åˆ—è¡¨ä¸­çš„ (N-1)*2 å’Œ (N-1)*2 + 1 ç´¢å¼•
    current_turn_index = (turn_number - 1) * 2
    
    # ç¡®ä¿ç´¢å¼•æœ‰æ•ˆï¼ˆåŒé‡ä¿é™©ï¼‰
    if current_turn_index + 1 >= len(history):
        raise ValueError(f"history æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•è·å–ç¬¬ {turn_number} å›åˆ")
    
    user_content = history[current_turn_index]["content"]
    assistant_content = history[current_turn_index + 1]["content"]

    # ä¸Šä¸‹æ–‡ï¼šå¾€å‰å–20ä¸ªå›åˆï¼ˆ40æ¡æ¶ˆæ¯ï¼‰
    context_before_start = max(0, current_turn_index - 40)
    context_turns_before = history[context_before_start:current_turn_index]

    # ä¸Šä¸‹æ–‡ï¼šå¾€åå–20ä¸ªå›åˆï¼ˆ40æ¡æ¶ˆæ¯ï¼‰
    context_after_start = current_turn_index + 2
    context_after_end = context_after_start + 40
    context_turns_after = history[context_after_start:context_after_end]

    return {
        "context_turns_before": context_turns_before,
        "current_turn": {
            "user_content": user_content,
            "assistant_content": assistant_content
        },
        "context_turns_after": context_turns_after
    }

async def process_all_chapters(history: list[dict], turn_range: tuple[int, int], output_dir: str, concurrency_limit: int, model: str, base_url: str | None):
    """å¹¶å‘å¤„ç†æ‰€æœ‰æŒ‡å®šçš„ç« èŠ‚"""
    from tqdm.asyncio import tqdm_asyncio
    
    try:
        client = AsyncOpenAI(base_url=base_url)
        # ç®€å•æµ‹è¯•ä¸€ä¸‹API Keyæ˜¯å¦æœ‰æ•ˆ
        await client.models.list(timeout=5)
        print("âœ… OpenAI API Key éªŒè¯é€šè¿‡ã€‚")
    except Exception as e:
        print(f"âŒ è¿æ¥ OpenAI API å¤±è´¥: {e}")
        print("è¯·æ£€æŸ¥æ‚¨çš„ OPENAI_API_KEY ç¯å¢ƒå˜é‡å’Œç½‘ç»œè¿æ¥ã€‚")
        return

    semaphore = asyncio.Semaphore(concurrency_limit)
    start_turn, end_turn = turn_range
    
    tasks = []
    for turn_number in range(start_turn, end_turn + 1):
        task = asyncio.create_task(process_single_chapter(
            client=client,
            semaphore=semaphore,
            history=history,
            turn_number=turn_number,
            output_dir=output_dir,
            model=model
        ))
        tasks.append(task)
    
    print(f"\nğŸ“Š å¼€å§‹å¤„ç† {len(tasks)} ä¸ªç« èŠ‚...")
    results = await tqdm_asyncio.gather(
        *tasks,
        desc="è½¬å†™è¿›åº¦",
        total=len(tasks),
        unit="ç« "
    )
    
    success_count = sum(1 for r in results if r)
    fail_count = len(results) - success_count
    
    print("\n--- âœ¨ è½¬å†™å®Œæˆ ---")
    print(f"âœ… æˆåŠŸ: {success_count} ç« ")
    if fail_count > 0:
        print(f"âŒ å¤±è´¥: {fail_count} ç« ")
    print(f"æ‰€æœ‰æ–‡ä»¶å·²ä¿å­˜åˆ° '{output_dir}' ç›®å½•ã€‚")

def get_user_range(total_turns: int) -> tuple[int, int] | None:
    """è·å–ç”¨æˆ·è¾“å…¥çš„å›åˆèŒƒå›´"""
    default_range = f"1-{total_turns}"
    while True:
        try:
            user_input = input(f"è¯·è¾“å…¥è¦ç”Ÿæˆçš„ç« èŠ‚èŒƒå›´ (ä¾‹å¦‚ '{default_range}', æˆ– '5', æˆ–ç›´æ¥å›è½¦ç”Ÿæˆå…¨éƒ¨): ").strip()
            if not user_input:
                return 1, total_turns

            if '-' in user_input:
                start_str, end_str = user_input.split('-')
                start = int(start_str.strip())
                end = int(end_str.strip())
            else:
                start = end = int(user_input.strip())

            if 1 <= start and start <= end and end <= total_turns:
                return start, end
            else:
                print(f"âš ï¸ æ— æ•ˆèŒƒå›´ã€‚è¯·è¾“å…¥ 1 åˆ° {total_turns} ä¹‹é—´çš„æ•°å­—ã€‚")
        except ValueError:
            print(f"âš ï¸ æ— æ•ˆè¾“å…¥ã€‚è¯·è¾“å…¥æ­£ç¡®çš„æ ¼å¼ (ä¾‹å¦‚ '{default_range}' æˆ– '5')ã€‚")
        except Exception as e:
            print(f"âŒ å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}")
            return None

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description="å°† AI GAME ä¼šè¯å†å²æ‰¹é‡è½¬å†™ä¸ºç½‘ç»œå°è¯´ç« èŠ‚ã€‚",
        formatter_class=argparse.RawTextHelpFormatter
    )
    parser.add_argument("input_file", nargs='?', default=None, help="è¾“å…¥çš„ JSON æ¸¸æˆå†å²æ–‡ä»¶è·¯å¾„ (å¯é€‰)ã€‚")
    parser.add_argument("-o", "--output-dir", default="outputs", help="å­˜æ”¾ç”Ÿæˆç« èŠ‚çš„è¾“å‡ºç›®å½• (é»˜è®¤: 'outputs')ã€‚")
    parser.add_argument("-c", "--concurrency", type=int, default=5, help="å¹¶å‘è¯·æ±‚ OpenAI API çš„æœ€å¤§æ•°é‡ (é»˜è®¤: 5)ã€‚")
    parser.add_argument("--model", type=str, default="gpt-4o", help="æŒ‡å®šä½¿ç”¨çš„æ¨¡å‹ (é»˜è®¤: 'gpt-4o')ã€‚")
    parser.add_argument("--base-url", type=str, default=None, help="æŒ‡å®š OpenAI API çš„ base_url (å¯é€‰)ã€‚")
    
    args = parser.parse_args()

    input_file = args.input_file
    # å¦‚æœæ²¡æœ‰æä¾›è·¯å¾„ï¼Œåˆ™æç¤ºç”¨æˆ·è¾“å…¥
    while not input_file or not os.path.exists(input_file):
        if input_file:
            print(f"âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ–‡ä»¶ '{input_file}'")
        
        user_input = input("è¯·è¾“å…¥ JSON æ¸¸æˆå†å²æ–‡ä»¶çš„è·¯å¾„ (æˆ–ç›´æ¥å›è½¦é€€å‡º): ").strip().strip('\'"')
        if not user_input:
            print("ğŸ‘‹ å·²å–æ¶ˆæ“ä½œã€‚")
            return
        input_file = user_input

    if "OPENAI_API_KEY" not in os.environ:
        print("âŒ é”™è¯¯: è¯·è®¾ç½® OPENAI_API_KEY ç¯å¢ƒå˜é‡ã€‚")
        print("ğŸ’¡ æç¤º: export OPENAI_API_KEY='your_key_here'")
        return

    # åŠ è½½å†å²æ–‡ä»¶
    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            game_data = json.load(f)
    except (json.JSONDecodeError, IOError) as e:
        print(f"âŒ è¯»å–æˆ–è§£æ JSON æ–‡ä»¶å¤±è´¥: {e}")
        return
    
    history = game_data.get("history", [])
    if not history or len(history) % 2 != 0:
        print("âŒ é”™è¯¯: JSON ä¸­çš„ 'history' å­—æ®µæ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©ºã€‚å®ƒåº”è¯¥æ˜¯ user/assistant æˆå¯¹å‡ºç°çš„åˆ—è¡¨ã€‚")
        return

    total_turns = len(history) // 2
    print(f"âœ… æˆåŠŸåŠ è½½æ¸¸æˆå†å²: {os.path.basename(input_file)}ï¼Œå…± {total_turns} ä¸ªå›åˆã€‚")
    
    # è·å–ç”¨æˆ·è¾“å…¥çš„èŒƒå›´
    turn_range = get_user_range(total_turns)
    if turn_range is None:
        return
    
    start_turn, end_turn = turn_range

    print(f"ğŸš€ å‡†å¤‡ç”Ÿæˆç¬¬ {start_turn} åˆ° {end_turn} å›åˆçš„ç« èŠ‚ (å…± {end_turn - start_turn + 1} ç« )...")
    print(f"âš¡ å¹¶å‘æ•°ä¸Šé™: {args.concurrency}")
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    os.makedirs(args.output_dir, exist_ok=True)
    
    # è¿è¡Œå¼‚æ­¥å¤„ç†
    asyncio.run(process_all_chapters(
        history=history,
        turn_range=turn_range,
        output_dir=args.output_dir,
        concurrency_limit=args.concurrency,
        model=args.model,
        base_url=args.base_url
    ))

if __name__ == "__main__":
    # æç¤ºç”¨æˆ·éœ€è¦å®‰è£…çš„åº“
    try:
        import openai  # noqa: F401
        from tqdm.asyncio import tqdm_asyncio  # noqa: F401
    except ImportError:
        print("="*50)
        print("âš ï¸  æ£€æµ‹åˆ°ä¾èµ–åº“ç¼ºå¤±ï¼")
        print("è¯·å…ˆè¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…æ‰€éœ€åº“:")
        print("   pip install openai tqdm")
        print("="*50)
        exit(1)
    
    main()
